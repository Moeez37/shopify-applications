<style>
    .wishlist-proX-btn-container {
        width: 100%;
        height: 4.4rem;
    }

    .wishlist-proX-btn {
        display: flex;
        align-items: center;
        justify-content: center;
        font: inherit;
        cursor: pointer;
        font-size: 15px;
        border-radius: 11px;
        /* width: 100%;
        height: 100%; 
        border: none;
        background: #121212 !important;
        color: #FFF !important;*/
        width: {{ block.settings.button_width }}px;
        height: {{ block.settings.button_height }}px;
        border: {{ block.settings.button_border_width }}px solid {{ block.settings.button_border_color }};
        background: {{ block.settings.button_bg }} !important;
        color: {{ block.settings.button_text_color }} !important;
        transition: background 0.3s ease-in-out;
    }

    .wishlist-proX-add-to-wishlist {
        /* background: #121212 !important; */
        /* color: #FFF !important; */
    }

    .wishlist-proX-heart {
        width: 1.7rem;
        height: 1.7rem;
        stroke: {{ block.settings.heart_color }};
        margin-right: 5px;
        transition: color 0.3s ease-in-out;
    }

    .wishlist-proX-heart.active {
        color: red;
    }

    .wishlist-proX-btn.active {
        background: #A0A0A0 !important;
    }

    .wishlist-prox-product-message {
        position: absolute;
        top: 0;
        left: -100%;
        width: auto;
        height: auto;
        padding: 1rem;
        background: #000;
        color: white;
        font-size: 14px;
        font-weight: bold;
        border-radius: 10px;
        z-index: 1000;
        opacity: 0;
        transition: left 1s ease-in-out, opacity 1s ease-in-out;
    }

    .wishlist-prox-product-message.show {
        left: 0;
        opacity: 1;
    }

    .wishlist-prox-product-message h2 {
        font-size: 15px;
        font-weight: bold; 
        color: #fff;
    }
</style>


{%- assign current_variant = product.selected_or_first_available_variant -%}

<div class="wishlist-proX-btn-container" x-data="wishlistProX">
    <button 
        type="button"
        @click.debounce="handleWishlistButton()"
        class="wishlist-proX-btn wishlist-proX-add-to-wishlist" 
        id="wishlist-proX-btn-Id"
        aria-label="Add To Wishlist"
        data-product-id="{{ product.id }}"
        data-product-title="{{ product.title }}"
        data-product-handle="{{ product.handle }}"
        data-product-img="{{ product.featured_image | image_url: ''}}"
        data-variant-id="{{ current_variant.id }}"
        data-variant-title="{{ current_variant.title }}"
        data-variant-price="{{ current_variant.price | money }}"
    >
        <svg class="wishlist-proX-heart" viewBox="0 0 24 24" stroke-width="2" stroke="{{ block.settings.heart_color }}" :fill="wishlisted ? '{{ block.settings.heart_color }}' : '#fff' ">
            <path d="M12 21.35l-1.45-1.32C5.4 15.73 2 12.27 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.77-3.4 7.23-8.55 11.53L12 21.35z"/>
        </svg>
        <span class="wishlist-proX-context" x-text="wishlisted ? '{{ block.settings.wishlist_text_added }}' : '{{ block.settings.wishlist_text_default }}'">
            {{ block.settings.wishlist_text_default }}
        </span>

        {% comment %} 
            <svg class="wishlist-proX-heart" viewBox="0 0 24 24" stroke-width="2" stroke="#000" :fill="wishlisted ? 'red': '#fff' ">
                <path d="M12 21.35l-1.45-1.32C5.4 15.73 2 12.27 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.77-3.4 7.23-8.55 11.53L12 21.35z"/>
            </svg>
            <span class="wishlist-proX-context" x-text="wishlisted ? 'Added to Wishlist' : 'Add to Wishlist'" > Add to Wishlist </span>
        {% endcomment %}
    </button>
</div>

<div class="wishlist-prox-product-message"></div>

<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
{% comment %} <script src="https://code.jquery.com/jquery-3.7.1.js" ></script> {% endcomment %}

<script>
    console.log(" === Wishlist ProX Product Page ===");

    const current_product_json = {{ product | json }};
    const productTitle = current_product_json?.title;
    const current_variant = {{ product.selected_or_first_available_variant | json }};
    // console.log("current_variant :", current_variant);

    // Using Alpine
    document.addEventListener('alpine:init', () => {
        // console.log("Alpine Init");

        Alpine.data('wishlistProX', () => ({
            init() { //This will run on initialize

                // Check if current product is added to local storage
                const productIsAlreadyAdded = checkFromWishlistLocalStorage(productTitle);
                console.log("productIsAlreadyAdded :", productIsAlreadyAdded);

                if(productIsAlreadyAdded) {
                    this.wishlisted = true;
                // } else {
                // OR Check current product from DB 
                //     fetch(this.appUrl + 'api/wishlist-pro-x' + '?shop={{ shop.permanent_domain }}&productId={{ product.id }}')
                //     .then(response => response.json())
                //     .then(result => {
                //         console.log('GET Result:', result);
                //         if(result.length > 0) {
                //             this.wishlisted = true
                //         }
                //     })
                //     .catch(error => console.error('error while getting wishlist data:', error));
                }
            },

            wishlisted: false,
            appUrl: "http://localhost:58013/", //[DEV] Change this for production 
            // appUrl: "https://wishlist-pro-x.fly.dev/",

            handleWishlistButton() {
                // console.log("In Function handleWishlist Button!");
                this.wishlisted = !this.wishlisted;
                // console.log("wishlisted 11 ", this.wishlisted);

                // Send data to database
                if(this.wishlisted) {
                    var formdata = new FormData();
                    formdata.append("productId", "{{ product.id }}");
                    formdata.append("shop", "{{ shop.permanent_domain }}");
                    formdata.append("_action", "CREATE"); // used to set flag to create, delete etc
    
                    const requestOptions = {
                        method: "POST",
                        body: formdata,
                        redirect: "follow"
                    };
    
                    fetch(this.appUrl + 'api/wishlist-pro-x', requestOptions)
                    .then((response) => response.text())
                    .then((result) => {
                        // console.log("ADD result :", result);
                        // this.wishlisted = !this.wishlisted;
                    })
                    .catch((error) => console.error('error', error));

                } else if(!this.wishlisted) {
                    var formdata = new FormData();
                    formdata.append("productId", "{{ product.id }}");
                    formdata.append("shop", "{{ shop.permanent_domain }}");
                    formdata.append("_action", "REMOVE");
    
                    const requestOptions = {
                        method: "POST",
                        body: formdata,
                        redirect: "follow"
                    };
    
                    fetch(this.appUrl + 'api/wishlist-pro-x', requestOptions)
                    .then((response) => response.text())
                    .then((result) => {
                        // console.log("REMOVE result :", result);
                        // this.wishlisted = !this.wishlisted;
                    })
                    .catch((error) => console.error('error', error));
                }

                // Get variant 
                let productSelectedVariant = `${current_variant?.id}`;

                const urlParams = new URLSearchParams(window.location.search);                
                const variantIdFromUrl = urlParams?.get("variant");
                // console.log("variantIdFromUrl :", variantIdFromUrl);
                if(variantIdFromUrl) {
                    productSelectedVariant = variantIdFromUrl;
                }

                const productData = {
                    productId: "{{ product.id }}",
                    productTitle: "{{ product.title }}",
                    productImg: "{{ product.featured_image | img_url: '' }}",
                    productPrice: "{{ product.price | money | remove_first: '' }}",
                    productUrl: "{{ product.url }}",
                    variantId: productSelectedVariant,
                };
                // console.log("productData :", productData);

                if(this.wishlisted) {
                    addToWishlistLocalStorage(productData);
                } else {
                    removeFromWishlistLocalStorage(productData);
                }
            }
        }));
    });


    // Save to Local Storage
    function addToWishlistLocalStorage(productData) {
        let wishlistData = JSON.parse(localStorage.getItem('wishlistProX')) || [];
        // console.log("wishlistData 11:", wishlistData);

        const isAlreadyInWishlist = wishlistData.some(item => item.productTitle === productData.productTitle);
        // console.log("isAlreadyInWishlist :", isAlreadyInWishlist);

        if (!isAlreadyInWishlist) {
            wishlistData.push(productData);
            localStorage.setItem('wishlistProX', JSON.stringify(wishlistData));
            displayMessage('ADD');
            // alert('Product added to wishlist:', productData.productTitle);
        }
    };

    // Remove from Local Storage 
    function removeFromWishlistLocalStorage(productData) {
        let wishlistData = JSON.parse(localStorage.getItem('wishlistProX')) || [];
        // console.log("wishlistData 22:", wishlistData);

        wishlistData = wishlistData.filter(item => item.productTitle !== productData.productTitle);
        localStorage.setItem('wishlistProX', JSON.stringify(wishlistData));
        displayMessage('REMOVE');
        // alert('Product removed from wishlist:', productData.productTitle);
    };

    // Check Current Product exist in Local Storage
    function checkFromWishlistLocalStorage(productTitle) {
        let wishlistData = JSON.parse(localStorage.getItem('wishlistProX')) || [];
        // console.log("wishlistData 33", wishlistData);
        const isAlreadyInWishlist = wishlistData.some(item => item.productTitle === productTitle);
        return isAlreadyInWishlist;
    };

    // Function to display message 
    function displayMessage(status) {
        let msgElement = document.querySelector('.wishlist-prox-product-message');
        // console.log("msgElement MM:", msgElement);

        if(!msgElement) {
            msgElement = document.createElement('div');
            msgElement.classList.add('wishlist-prox-product-message');
            document.body.appendChild(msgElement);
        }

        let message = '';

        if(status === 'ADD') {
            message = "✅ Product added to wishlist!";
        } else if (status === 'REMOVE') {
            message = "❌ Product removed from wishlist!";
        }

        msgElement.innerHTML = `<h2>${message}</h2>`;
        msgElement.classList.add("show");

        // Hide message after 3 seconds
        setTimeout(() => {
            msgElement.classList.remove("show");
        }, 2000);
    };


    // function handleWishlistButton(button) {
    //     console.log("Button Clicked 1122 ");
    //     // console.log("button :", button);

    //     // Retrieve product and variant details from data attributes
    //     let productId = button.getAttribute("data-product-id");
    //     let productTitle = button.getAttribute("data-product-title");
    //     let productHandle = button.getAttribute("data-product-handle");
    //     let variantId = button.getAttribute("data-variant-id");
    //     let variantTitle = button.getAttribute("data-variant-title");
    //     let variantPrice = button.getAttribute("data-variant-price");

    //     console.log("Product ID:", productId);
    //     console.log("Product Title:", productTitle);
    //     console.log("Product Handle:", productHandle);
    //     console.log("Variant ID:", variantId);
    //     console.log("Variant Title:", variantTitle);
    //     console.log("Variant Price:", variantPrice);

    //     heartIcon.classList.toggle("active");

    //     if (heartIcon.classList.contains("active")) {
    //         buttonText.textContent = "Added to Wishlist";
    //     } else {
    //         buttonText.textContent = "Add to Wishlist";
    //     }

    //     // Example: Send product info to backend or localStorage
    //     let wishlistItem = {
    //         productId: productId || null,
    //         productTitle: productTitle || null,
    //         productHandle: productHandle || null,
    //         variantId: variantId || null,
    //         variantTitle: variantTitle || null,
    //         variantPrice: variantPrice || null,
    //     };
    //     console.log("Wishlist Item:", wishlistItem);
    // };
</script>
