<div id="wishlist-prox-widget-container">  
  <!-- Spinner Placeholder -->
  <div id="wishlist-prox-loading" class="wishlist-prox-loading">
    <p>Loading trending wishlist...</p>
    <div class="wishlist-prox-loading-spinner"></div>
  </div>
</div>
<div id="wishlist-prox-notification" class="wishlist-prox-notification"></div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const proXIcon = document.getElementById('wishlist-prox-heart-icon-Id');
    const floatingBtn = document.querySelector(".wishlist-prox-app-embed2 img");
    // console.log("proXIcon :", proXIcon);
    // console.log("floatingBtn :", floatingBtn);

    function handleClick(event) { trendingWishlistWidget() }

    if (proXIcon) { proXIcon.addEventListener('click', handleClick)}
    if (floatingBtn) { floatingBtn.addEventListener('click', handleClick)}

    
    async function trendingWishlistWidget() {
      const proxyUrl = "/apps/wishlist-prox-app-proxy"; // Shopify forwards this request
      let formdata = new FormData();
      formdata.append("_action", 'TRENDING_WISHLIST_GET');
  
      const requestOptions = {
        method: "POST",
        body: formdata,
        redirect: "follow"
      };
      
      await fetch(`${proxyUrl}`, requestOptions)
      .then((response) => response.text())
      .then((result) => {
        let loadingElement = document.getElementById("wishlist-prox-loading");
        if (loadingElement) { loadingElement.style.display = 'none';}

        document.getElementById("wishlist-prox-widget-container").innerHTML = result; 
        renderTrendingATC();
      })
      .catch((error) => {
        console.error('error', error);
        document.getElementById("wishlist-prox-widget-container").innerHTML = "<p>Error loading wishlist. Please try again.</p>";
      });
    }

    async function renderTrendingATC() {
      const all_ATC_Buttons = document.querySelectorAll(".wishlistProX-addToCart-Btn");
      all_ATC_Buttons.forEach(button => {
        button.addEventListener("click", async function () {
          const variantId = this.getAttribute("data-variant-id");
          if (!variantId) {
            showNotification("No variant available for this product.", true);
            return;
          }

          const formData = {
            id: variantId,
            quantity: 1
          };

          try {
            const response = await fetch("/cart/add.js", {
              method: "POST",
              headers: {
                "Content-Type": "application/json"
              },
              body: JSON.stringify(formData)
            });
            if (response.ok) {
              showNotification("Item added to cart Successfully!");
            } else {
              showNotification("Error adding item to cart", true);
            }
          } catch (error) {
            console.error("Error:", error);
            showNotification("Something went wrong. Please try again", true);
          }
        });
      });
    };

    function showNotification(message, isError = false) {
      const notification = document.getElementById("wishlist-prox-notification");
      notification.textContent = message;
      notification.classList.toggle("error", isError);
      notification.style.top = "5%";
      setTimeout(() => {
        notification.style.top = "-60px";
      }, 3000);
    }
  });
</script>

<style>
  .wishlist-prox-widget {
    height: 80vh;
    background: #51C0FF;
    border: 1px solid #ddd;
    border-radius: 8px;
    overflow-y: auto;
  }
  .wishlist-prox-widget h3 {
    font-size: 18px;
    font-weight: bold;
    text-align: center;
  }
  .wishlist-prox-widget-items {
    margin: 3rem 0;
  }
  .wishlist-prox-widget-item {
    display: flex;
    flex-direction: row;
    gap: 10px;
    margin: 2rem 1rem 2rem 5px;
    text-align: start;
    background-color: #1d9fe9;
    border-radius: 10px;
  }
  .wishlist-prox-widget-item img {
    max-width: 100px;
    height: -webkit-fill-available;
    border-radius: 10px;
  }
  .wishlist-prox-widget-item-content h2 {
    font-size: 18px;
    margin: 10px 0;
  }
  .wishlist-prox-widget-item-content p {
    font-size: 16px;
    margin: 2px;
  }
  .wishlistProX-addToCart-Btn {
    background: #ffffff;
    color: #1782be;
    border-radius: 5px;
    padding: 5px 10px;
    margin: 5px 0;
    font-size: 14px;
    font-weight: bold;
    width: 100%;
    cursor: pointer;
  }
  /* Spinner Styles */
  .wishlist-prox-loading {
    display: block;
    font-size: 16px;
    font-weight: bold;
    text-align: center;
    padding: 2rem;
    height: 75vh;
    background: #51C0FF;
    border-radius: 10px;
  }
  .wishlist-prox-loading-spinner {
    display: block !important;
    width: 40px;
    height: 40px;
    border: 4px solid rgba(255, 255, 255, 0.3);
    border-radius: 50%;
    border-top-color: #1782be;
    animation: spin 1s linear infinite;
    margin: 0 auto;
  }
  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }
  /* Notification Message Styles */
  .wishlist-prox-notification {
    position: fixed;
    top: -60px;
    right: 0;
    transform: translateX(-50%);
    background-color: #28a745;
    color: #fff;
    padding: 15px 20px;
    font-size: 16px;
    font-weight: bold;
    border-radius: 5px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    transition: top 0.5s ease-in-out;
    z-index: 1000;
  }
  .wishlist-prox-notification.error {
    background-color: #dc3545;
  }
</style>
